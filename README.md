# A股选股程序 - Tushare版本

基于Python3和tushare的A股选股程序，采用多维度打分策略进行股票筛选。支持本地缓存机制、数据预加载、多线程处理，大幅提升运行速度。

## 功能特点

- **多维度评分**：综合考虑基本面、成交量、成交价格三个维度
- **子维度细化**：每个大维度下包含多个子维度，评分更加精准
- **权重可配置**：支持自定义各维度权重，灵活调整选股策略
- **TOP结果输出**：自动筛选并输出评分最高的股票
- **本地缓存机制**：所有数据（K线、基本面、财务）自动缓存到本地SQLite数据库，大幅提升运行速度；K线数据支持增量更新和自动清理
- **数据预加载**：支持提前批量获取并缓存数据，首次运行后速度提升10-100倍
- **多线程支持**：使用多线程并行处理，大幅提升处理速度
- **板块筛选**：支持按板块类型筛选（主板、创业板、科创板、北交所、B股），默认只选主板
- **策略扩展性**：采用策略模式，便于扩展新的选股策略
- **缓存控制**：支持强制刷新缓存，确保数据最新
- **稳定数据源**：基于tushare，提供稳定的数据源，避免限流问题
- **智能容错**：自动处理缺失指标，根据数据可用性动态调整权重

## 项目结构

```
stock-selector-tushare/
├── config.py                 # 配置文件（权重、参数等）
├── stock_selector.py         # 主程序（支持多策略）
├── requirements.txt          # 依赖包
├── README.md                 # 说明文档（本文件）
│
├── data/                     # 数据模块
│   ├── __init__.py
│   ├── cache_manager.py      # 缓存管理模块
│   └── fetcher.py            # 数据获取模块（基于tushare）
│
├── strategies/               # 策略模块
│   ├── __init__.py
│   ├── base_strategy.py      # 基础策略类
│   └── scoring_strategy.py   # 打分策略（当前策略）
│
├── scorers/                  # 评分模块目录
│   ├── __init__.py
│   ├── fundamental_scorer.py   # 基本面评分
│   ├── volume_scorer.py        # 成交量评分
│   └── price_scorer.py         # 价格评分
│
└── cache/                    # 缓存目录（自动创建）
    └── stock_cache.db         # SQLite数据库文件
```

## 快速开始

### 1. 安装依赖

```bash
pip install -r requirements.txt
```

### 2. 配置Tushare Token

**重要**：使用本程序前，必须先配置tushare token。

#### 获取Token

1. 访问 [Tushare官网](https://tushare.pro/register) 注册账号
2. 登录后，进入"接口"页面，复制您的Token
3. 了解积分限制：Tushare采用积分制度管理API访问权限

#### 配置方式（三种方式任选一种，优先级从高到低）

**方式1：环境变量（推荐）⭐**

**Windows PowerShell**：
```powershell
# 临时设置（当前会话有效）
$env:TUSHARE_TOKEN="your_token_here"

# 永久设置（用户级别）
[System.Environment]::SetEnvironmentVariable("TUSHARE_TOKEN", "your_token_here", "User")
```

**Windows CMD**：
```cmd
# 临时设置（当前会话有效）
set TUSHARE_TOKEN=your_token_here

# 永久设置（用户级别，重启CMD后生效）
setx TUSHARE_TOKEN "your_token_here"
```

**Linux/Mac**：
```bash
# 临时设置（当前会话有效）
export TUSHARE_TOKEN="your_token_here"

# 永久设置（添加到 ~/.bashrc 或 ~/.zshrc）
echo 'export TUSHARE_TOKEN="your_token_here"' >> ~/.bashrc
source ~/.bashrc
```

**方式2：配置文件**

编辑 `config.py` 文件：
```python
TUSHARE_TOKEN = "your_token_here"  # 替换为您的实际Token
```

**注意**：⚠️ 不要将包含Token的config.py提交到Git仓库

**方式3：代码中设置**

```python
import tushare as ts
ts.set_token('your_token_here')
```

#### 验证配置

运行测试脚本验证Token配置：
```bash
python test_token.py
```

如果看到 "✅ Token配置验证通过！" 表示配置成功。

### 3. 运行程序

```bash
# 获取TOP10推荐（主板股票）
python stock_selector.py --top-n 10 --board main

# 获取TOP20推荐（默认）
python stock_selector.py --board main

# 强制刷新缓存并获取TOP10
python stock_selector.py --refresh --top-n 10 --board main
```

**注意**：首次运行可能需要较长时间下载数据，建议在网络良好的环境下运行。后续运行会使用缓存数据，速度会快很多。

## 使用说明

### 命令行参数

```bash
python stock_selector.py --help
```

主要参数：

- `--refresh`: 强制刷新缓存
- `--strategy`: 选股策略（当前仅支持scoring）
- `--top-n`: 返回前N只股票（默认20）
- `--stocks`: 指定股票代码列表（如：`--stocks 000001 000002`）
- `--board`: 板块类型（main/sme/gem/star/bse/b），可多选（如：`--board main gem`）
- `--workers`: 线程数（默认10）

### 使用示例

```bash
# 选择主板前10只股票
python stock_selector.py --board main --top-n 10

# 评估指定股票
python stock_selector.py --stocks 000001 000002 600000

# 选择主板和创业板股票
python stock_selector.py --board main gem --top-n 30

# 强制刷新缓存
python stock_selector.py --refresh --board main
```

### 程序输出说明

程序运行后会显示以下信息：

#### 1. 程序启动信息

```
============================================================
A股选股程序 - 打分策略
============================================================
当前状态：非交易时间，使用最近一个交易日的完整数据进行分析
```

#### 2. 数据预加载阶段

程序会先预加载所有股票的数据，显示进度条和统计信息。

#### 3. 评分计算阶段

基于预加载的数据计算各维度评分。

#### 4. 数据可用性统计

```
============================================================
数据可用性统计:
  基本面数据: XXX/XXX (XX.X%)
  财务数据: XXX/XXX (XX.X%)
============================================================
```

**说明**：如果某个维度的数据可用性为0%，程序会自动调整权重。

#### 5. TOP推荐结果

```
============================================================
TOP 10 只股票:
============================================================

【最终打分维度说明】
------------------------------------------------------------
采用的评分维度及权重：
  ✓ 基本面评分: 40.0%
    └─ 子维度: PE市盈率, PB市净率, ROE净资产收益率, 营收增长率, 利润增长率
  ✓ 成交量评分: 30.0%
    └─ 子维度: 量比, 换手率, 成交量趋势
  ✓ 价格评分: 30.0%
    └─ 子维度: 价格趋势, 价格位置, 波动率

【缺失指标提示】
------------------------------------------------------------
  ⚠ 财务数据未采用（数据不可用或权重已调整）
    原因: 财务数据（ROE、增长率）缺失或无效

============================================================
     code    name  total_score  fundamental_score  volume_score  price_score
1  000001  平安银行     85.32             78.50         92.30         88.20
2  000002  万科A       84.15             75.20         90.10         85.30
...

============================================================
【评分说明】
------------------------------------------------------------
总评分 = 基本面评分 × 40.0% + 成交量评分 × 30.0% + 价格评分 × 30.0%
============================================================
```

## 评分维度说明

### 评分体系

程序采用**多维度加权评分**体系，总评分 = Σ(各维度得分 × 对应权重)

- 各维度得分范围：0-100分
- 所有权重总和：100%
- 最终得分范围：0-100分

### 各维度详细说明

#### 1. 基本面评分（权重：40%）

包含以下子维度：

- **PE市盈率**（权重20%）：越低越好，0-20为满分
- **PB市净率**（权重20%）：越低越好，≤1为满分
- **ROE净资产收益率**（权重25%）：越高越好，≥20%为满分
- **营收增长率**（权重20%）：越高越好，≥50%为满分
- **利润增长率**（权重15%）：越高越好，≥50%为满分

#### 2. 成交量评分（权重：30%）

包含以下子维度：

- **量比**（权重40%）：成交量与平均成交量的比值
- **换手率**（权重30%）：股票流通性指标
- **成交量趋势**（权重30%）：成交量变化趋势

#### 3. 价格评分（权重：30%）

包含以下子维度：

- **价格趋势**（权重35%）：价格走势方向
- **价格位置**（权重30%）：相对高低位置
- **波动率**（权重35%）：价格波动程度

### 缺失指标处理

程序采用**智能容错机制**处理缺失指标：

- **缺失数据时**：使用默认中等分（50分）参与计算
- **所有股票都缺失某个维度时**：自动将该维度权重设为0，并重新归一化其他权重
- **部分股票缺失数据时**：缺失数据的股票使用默认分，不影响其他股票评分

**各维度缺失指标的处理**：

- **基本面数据缺失**：PE/PB/ROE/增长率缺失时使用默认分50分；如果所有股票都缺失基本面数据，基本面权重设为0
- **财务数据缺失**：ROE/增长率缺失时使用默认分50分；如果所有股票都缺失财务数据，财务相关权重会从基本面权重中移除

## 配置说明

### 权重配置

编辑 `config.py` 文件可以调整各维度权重：

```python
# 各维度权重配置（总和应为1.0）
WEIGHT_CONFIG = {
    'fundamental': 0.40,      # 基本面权重
    'volume': 0.30,           # 成交量权重
    'price': 0.30,            # 成交价格权重
}
```

### 板块类型配置

```python
# 默认板块筛选（只选主板）
DEFAULT_BOARD_TYPES = ['main']  # 可以修改为 ['main', 'gem'] 等
```

## 本地缓存机制

### SQLite数据库存储

程序使用SQLite数据库进行数据缓存，提供高效稳定的本地存储：

```
cache/
└── stock_cache.db          # SQLite数据库文件
```

#### 数据库表结构
- `fundamental_data`：基本面数据（PE、PB、ROE等）
- `financial_data`：财务数据（ROE等）
- `stock_sectors`：板块数据
- `stock_concepts`：概念数据
- `stock_list`：股票列表
- `kline_data`：K线数据

### 缓存有效期配置

不同数据类型有不同的缓存有效期（超过有效期后，缓存自动失效，会重新从API获取数据）：

| 数据类型 | 缓存有效期 | 说明 |
|---------|-----------|------|
| **K线数据** | 1天（当日有效） | 必须是今天，否则失效；检查最新交易日数据；自动保留最近250个交易日（约1年） |
| **股票列表** | 1天 | 超过1天自动失效，重新获取 |
| **基本面数据** | 7天 | 超过7天自动失效，重新获取 |
| **财务数据** | 7天 | 超过7天自动失效，重新获取（变化频率低） |

**注意**：
- 缓存有效期是指缓存数据的有效期，超过有效期后会自动失效并重新获取数据
- K线数据会自动清理，只保留最近250个交易日（约1年）的数据，可通过 `config.py` 中的 `KLINE_CACHE_RETENTION_DAYS` 配置项调整保留天数

### 刷新策略

#### K线数据刷新策略

- **智能日期检查**：优先检查缓存文件是否包含最新交易日的数据
- **交易时间感知**：
  - 交易时间内（9:30-11:30, 13:00-15:00）：使用昨天的完整数据（今天数据不完整）
  - 收盘后（15:00之后）：可以使用今天的数据（完整收盘数据）
  - 开盘前（9:30之前）：使用昨天的数据
  - 周末/非交易时间：使用最近一个交易日的完整数据
- **自动刷新**：如果缓存中最新数据不是最新交易日，自动从API获取最新数据
- **增量更新**：只获取缓存中最新日期之后的新数据，不会重复获取已存在的数据
- **自动清理**：保存时自动清理超过保留天数的旧数据，默认保留最近250个交易日（约1年）

#### 其他数据刷新策略

- **基本面数据**：缓存有效期7天，超过7天自动失效并重新获取，读取时验证数据有效性
- **财务数据**：缓存有效期7天，超过7天自动失效并重新获取（变化频率低），可通过 `--refresh` 强制刷新

### 强制刷新机制

```bash
# 强制刷新所有缓存
python stock_selector.py --refresh --board main
```

**强制刷新的行为**：
- 忽略所有缓存有效期检查
- 所有数据都从API重新获取
- 更新后的数据会保存到缓存

### 缓存完整性检查

程序启动时会自动检查缓存完整性：

- **覆盖率检查**：抽样检查缓存覆盖率（最多检查1000只股票）
- **自动预加载**：如果覆盖率低于50%，自动触发数据预加载
- **断点续传**：支持独立文件存储，便于断点续传

### 缓存存储结构

程序使用**SQLite数据库**统一存储所有缓存数据：

- **数据库文件**：`cache/stock_cache.db`
- **表结构**：按数据类型划分不同的表，支持高效的索引查询
- **并发安全**：数据库级别的锁机制，保证多线程操作的安全性

### 缓存更新时机

| 场景 | 刷新行为 |
|------|---------|
| **首次运行** | 所有数据从API获取并缓存（K线数据获取最近120天） |
| **日常运行** | 根据缓存有效期自动检查，过期数据自动失效并重新获取；K线数据增量更新（只获取新数据） |
| **使用 `--refresh`** | 强制刷新所有数据（K线数据重新获取最近120天，但会保留超过120天的旧数据） |
| **缓存无效** | 自动删除无效缓存并重新获取 |
| **覆盖率不足** | 自动触发预加载 |

### K线数据管理机制

- **增量更新**：日常运行时，只获取缓存中最新日期之后的新数据，不会重复获取已存在的数据
- **数据合并**：新数据会与现有缓存数据合并，保留所有历史数据
- **自动清理**：保存时自动清理超过保留天数的旧数据，默认保留最近250个交易日（约1年）
- **配置项**：可在 `config.py` 中通过 `KLINE_CACHE_RETENTION_DAYS` 调整保留天数

### 最佳实践建议

1. **首次使用**：首次运行会下载所有数据，需要较长时间，建议在网络良好的环境下运行
2. **日常使用**：正常运行时使用缓存，速度会快很多；K线数据会自动检查最新交易日
3. **数据更新**：财务数据变化频率低，缓存有效期7天；如需立即获取最新数据，使用 `--refresh` 参数强制刷新
4. **缓存清理**：
   - K线数据会自动清理，只保留最近250个交易日（约1年）的数据
   - 如需完全清理缓存，直接删除 `cache/` 目录；程序会自动重新创建缓存目录
   - 可在 `config.py` 中通过 `KLINE_CACHE_RETENTION_DAYS` 调整K线数据保留天数

## Tushare积分说明

### 积分等级对照表

| 积分数 | 每分钟调用次数 | 每日总调用次数上限 | 可访问的接口范围 | 捐助金额（元） |
|--------|---------------|-------------------|-----------------|---------------|
| **120** | 50 | 8,000 | 股票基础信息、股票非复权日线行情，其他接口无法调用 | 0（免费） |
| **2000以上** | 200 | 每个API每日100,000次 | Tushare Pro 60%的API可调用 | 200 |
| **5000以上** | 500 | 常规数据无上限 | Tushare Pro 90%的API可调用 | 500 |
| **10000以上** | 1,000 | 常规数据无上限，特色数据每分钟300次 | 包括盈利预测数据、每日筹码和胜率等特色数据权限 | 1,000 |

### 本程序使用的API接口

| API接口 | 用途 | 最低积分要求 | 说明 |
|---------|------|-------------|------|
| `stock_basic` | 获取股票列表 | 120 | 免费用户可用 |
| `daily` | 获取日K线数据 | 120 | 免费用户可用 |
| `daily_basic` | 获取每日指标（PE、PB、换手率等） | 120 | 免费用户可用 |
| `fina_indicator` | 获取财务指标（ROE等） | 2000 | 需要2000积分以上 |
| `income` | 获取利润表数据 | 2000 | 需要2000积分以上 |

### 评分器数据支持情况

| 评分器 | 免费用户（120积分） | 付费用户（2000积分） | 说明 |
|--------|-------------------|---------------------|------|
| **PriceScorer** | ✅ 完全可用 | ✅ 完全可用 | 价格数据完整 |
| **VolumeScorer** | ✅ 完全可用 | ✅ 完全可用 | 已优化换手率获取 |
| **FundamentalScorer** | ⚠️ 部分可用（仅PE、PB） | ✅ 完全可用 | ROE、增长率需付费 |

### 积分等级建议

- **免费用户（120积分）**：
  - ✅ 可以使用价格评分、成交量评分（含换手率）
  - ✅ 可以使用基本面评分（PE、PB）
  - ⚠️ 无法获取财务数据（ROE、增长率等），财务评分维度会使用默认值
  - ⚠️ 每日调用次数限制为8,000次，适合少量股票分析

- **2000积分用户（推荐）**：
  - ✅ 可以使用本程序的所有功能
  - ✅ 可以获取完整的财务数据（ROE、增长率）
  - ✅ 每日调用次数大幅提升（每个API 100,000次）
  - 💰 需要充值200元

- **5000积分及以上**：
  - ✅ 适合大规模批量分析
  - ✅ 常规数据无调用上限
  - ✅ 可以访问更多高级接口

### 如何查看和提升积分

1. **查看当前积分**：登录 [Tushare官网](https://tushare.pro/)，在"积分"页面查看
2. **提升积分**：
   - 免费用户：完成网站任务、邀请好友等方式获得积分
   - 付费用户：充值获得积分（1元=10积分）
3. **查看接口积分要求**：每个API接口的文档页面会显示所需的最低积分

## 常见问题

### Token配置相关问题

#### Q1: 提示"未设置Tushare Token"怎么办？

**解决方法**：
1. 检查是否设置了环境变量：`echo $TUSHARE_TOKEN`（Linux/Mac）或 `echo %TUSHARE_TOKEN%`（Windows CMD）
2. 检查config.py中是否设置了TUSHARE_TOKEN
3. 确保Token字符串正确（没有多余的空格或引号）
4. 运行 `python test_token.py` 进行诊断

#### Q2: 提示"权限不足"或"积分不足"怎么办？

**解决方法**：
1. 登录 [Tushare官网](https://tushare.pro/) 查看积分
2. **免费用户（120积分）**：只能使用基础功能，无法获取财务数据
3. **需要完整功能**：建议充值到2000积分以上（200元）
4. 查看具体接口要求：每个API接口的文档会显示所需的最低积分

#### Q3: 提示"Token无效"怎么办？

**解决方法**：
1. 重新登录Tushare官网，复制最新的Token
2. 确保Token字符串完整（没有截断）
3. 确保没有多余的空格或特殊字符
4. 重新配置Token并运行 `python test_token.py` 验证

### 其他问题

#### Q: 数据获取失败怎么办？

A: 
1. 检查网络连接
2. 检查token是否有效（运行 `python test_token.py`）
3. 检查积分是否充足
4. 尝试使用 `--refresh` 参数强制刷新
5. 查看错误信息，根据提示解决问题

#### Q: 如何清理缓存？

A: 删除 `cache/` 目录下的文件即可，或使用缓存管理工具。

#### Q: 程序运行很慢怎么办？

A: 
1. 首次运行会下载数据，需要较长时间
2. 后续运行会使用缓存，速度会快很多
3. 可以调整 `--workers` 参数增加线程数（但要注意tushare的积分限制）
4. 确保网络连接稳定

#### Q: 为什么某些维度的权重显示为0？

A: 如果所有股票都缺失该维度的数据，程序会自动将该维度权重设为0，避免无效数据影响评分。

#### Q: 如何确保所有维度数据都可用？

A: 
1. 确保Tushare Token积分≥2000（免费用户无法获取财务数据）
2. 使用 `--refresh` 参数强制刷新缓存
3. 在网络良好的环境下运行

#### Q: 评分公式是什么？

A: 总评分 = Σ(各维度得分 × 对应权重)
- 各维度得分范围：0-100分
- 所有权重总和：100%
- 最终得分范围：0-100分

## 注意事项

1. **Token配置**：必须配置有效的tushare token才能使用
2. **积分限制**：
   - 免费用户（120积分）只能使用基础功能，无法获取财务数据
   - 建议至少充值到2000积分以使用完整功能
   - 注意每日调用次数限制，合理使用缓存机制
3. **数据延迟**：部分数据可能有延迟，建议在收盘后使用
4. **缓存管理**：首次运行会下载数据，后续运行会使用缓存，速度更快
5. **API调用频率**：注意tushare的调用频率限制，避免触发限流
6. **ST股票**：程序会自动剔除ST股票

## 快速配置检查清单

在开始使用前，请确认：

- [ ] 已在Tushare官网注册账号
- [ ] 已获取Token
- [ ] 已通过环境变量或配置文件设置Token
- [ ] 已运行 `python test_token.py` 验证Token有效
- [ ] 已检查积分是否充足
- [ ] 已确认网络连接正常

完成以上步骤后，您就可以正常使用股票选股程序了！

## Git 中文提交信息乱码问题解决方案

### 问题说明

在Windows PowerShell中使用Git提交中文信息时，可能会出现乱码问题。这是因为PowerShell和Git的默认编码设置导致的。

### 解决方案

执行以下命令进行配置：

```powershell
# 设置Git全局配置
git config --global core.quotepath false
git config --global i18n.commitencoding utf-8
git config --global i18n.logoutputencoding utf-8
git config --global core.autocrlf false

# 设置PowerShell编码（每次打开PowerShell时执行）
[Console]::OutputEncoding = [System.Text.Encoding]::UTF8
$PSDefaultParameterValues['*:Encoding'] = 'utf8'
chcp 65001
```

### 验证配置

运行以下命令验证配置是否生效：

```powershell
git config --global --list | Select-String -Pattern "encoding|utf|i18n"
```

应该看到：
- `i18n.commitencoding=utf-8`
- `i18n.logoutputencoding=utf-8`

### 提交信息最佳实践

1. **使用UTF-8编码**：确保提交信息使用UTF-8编码
2. **使用文件方式提交**：如果直接在命令行输入中文有问题，可以使用文件方式：
   ```powershell
   # 创建提交信息文件
   "优化代码结构和功能改进" | Out-File -Encoding utf8 commit_msg.txt
   
   # 使用文件提交
   git commit -F commit_msg.txt
   ```
3. **使用提交模板**（可选）：可以配置提交模板，使用 `git commit` 时会自动打开模板

### 永久解决方案

将以下内容添加到PowerShell配置文件（`$PROFILE`）中：

```powershell
# Git UTF-8编码设置
[Console]::OutputEncoding = [System.Text.Encoding]::UTF8
$PSDefaultParameterValues['*:Encoding'] = 'utf8'
chcp 65001 | Out-Null
```

查看配置文件路径：
```powershell
$PROFILE
```

如果文件不存在，创建它：
```powershell
New-Item -Path $PROFILE -Type File -Force
```

然后使用文本编辑器添加上述内容。

**注意**：如果PowerShell显示仍有乱码，这是**显示问题**，实际提交到GitHub的内容是正确的。可以在GitHub网页上查看提交信息，确认是否正确显示。

## 许可证

本项目仅供学习和研究使用。

## 更新日志

### v1.4.0 (2024-12-19)
- **缓存系统重构**：从Excel存储完全迁移到SQLite数据库
  - 删除所有Excel缓存文件和兼容代码
  - 使用SQLite数据库提供更高效稳定的缓存存储
  - 简化首次运行逻辑，移除数据迁移检测
- **性能优化**：数据库查询比Excel文件操作更快
  - 支持事务操作保证数据一致性
  - 索引优化提升查询性能
  - 并发安全更稳定

### v1.3.0 (2024-12-18)
- **移除板块评分功能**：删除板块走势评分维度
  - 删除 `SectorScorer` 板块评分器
  - 删除板块K线数据获取和缓存逻辑
  - 删除板块趋势统计和显示功能
- **权重重新分配**：调整为三个维度
  - 基本面评分：40%（原35%）
  - 成交量评分：30%（原25%）
  - 价格评分：30%（原25%）
- 简化评分逻辑，提升运行效率

### v1.2.0 (2024-12-17)
- **板块数据优化**：使用 `index_classify` + `index_member` 获取标准行业分类
  - 使用申万一级行业分类（SW2021标准），共31个标准行业
  - 建立股票到行业的映射表，避免名称匹配失败
  - 直接使用行业指数代码获取K线数据，提高数据准确性
  - 首次运行时自动加载行业映射表，后续直接查表，查询速度快
- 修复板块趋势评分全部为50的问题
- 修复房地产等板块股票数量过少的问题

### v1.1.0 (2024-12-17)
- 移除概念维度评分（概念评分器 `concept_scorer.py` 已删除）
- 调整权重配置：基本面35%、成交量25%、价格25%、板块15%
- 更新文档，移除概念评分相关描述

### v1.0.0 (2024-12-15)
- 初始版本
- 基于tushare实现数据获取
- 支持多维度打分策略
- 支持本地缓存机制
- 支持数据预加载
- 完整的Token配置指南和测试工具
- 智能容错机制，自动处理缺失指标
- 根据数据可用性动态调整权重

