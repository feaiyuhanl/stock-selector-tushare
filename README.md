# A股选股程序 - Tushare版本

基于Python3和tushare的A股选股程序，采用多维度打分策略进行股票筛选。支持本地缓存机制、数据预加载、多线程处理，大幅提升运行速度。

## 功能特点

- **多维度评分**：综合考虑基本面、成交量、成交价格三个维度
- **子维度细化**：每个大维度下包含多个子维度，评分更加精准
- **权重可配置**：支持自定义各维度权重，灵活调整选股策略
- **TOP结果输出**：自动筛选并输出评分最高的股票
- **本地缓存机制**：所有数据（K线、基本面、财务）自动缓存到本地SQLite数据库，大幅提升运行速度；K线数据支持增量更新和自动清理
- **数据预加载**：支持提前批量获取并缓存数据，首次运行后速度提升10-100倍
- **多线程支持**：使用多线程并行处理，大幅提升处理速度
- **板块筛选**：支持按板块类型筛选（主板、创业板、科创板、北交所、B股），默认只选主板
- **策略扩展性**：采用策略模式，便于扩展新的选股策略
- **缓存控制**：支持强制刷新缓存，确保数据最新
- **稳定数据源**：基于tushare，提供稳定的数据源，避免限流问题
- **智能容错**：自动处理缺失指标，根据数据可用性动态调整权重
- **通知功能**：支持腾讯云邮件推送和企业微信通知，程序执行完成后自动发送结果通知
- **复盘功能**：自动跟踪推荐结果的表现，计算评分，支持手动复盘和补齐缺失数据（详见[复盘功能文档](docs/review.md)）

## 项目结构

```
stock-selector-tushare/
├── config.py                 # 配置文件（权重、参数等）
├── stock_selector.py         # 主程序（支持多策略）
├── requirements.txt          # 依赖包
├── README.md                 # 说明文档（本文件）
│
├── data/                     # 数据模块
│   ├── __init__.py
│   ├── cache_manager.py      # 缓存管理模块
│   └── fetcher.py            # 数据获取模块（基于tushare）
│
├── strategies/               # 策略模块
│   ├── __init__.py
│   ├── base_strategy.py      # 基础策略类
│   └── scoring_strategy.py   # 打分策略（当前策略）
│
├── scorers/                  # 评分模块目录
│   ├── __init__.py
│   ├── fundamental_scorer.py   # 基本面评分
│   ├── volume_scorer.py        # 成交量评分
│   └── price_scorer.py         # 价格评分
│
├── docs/                     # 文档目录
│   ├── setup.md              # 环境配置和安装指南
│   ├── configuration.md      # 参数配置说明
│   ├── cache.md              # 缓存机制说明
│   ├── scoring.md            # 评分指标说明
│   ├── review.md             # 复盘功能说明
│   └── tushare.md            # Tushare积分说明
│
├── autoreview/               # 自动复盘模块
│   ├── __init__.py
│   ├── auto_review.py        # 自动复盘核心逻辑
│   ├── review_cache.py       # 复盘数据缓存管理
│   └── review_helper.py      # 复盘工具函数
│
└── cache/                    # 缓存目录（自动创建）
    └── stock_cache.db         # SQLite数据库文件
```

## 快速开始

### 1. 安装依赖

```bash
pip install -r requirements.txt
```

### 2. 配置环境

**重要**：使用本程序前，必须先配置tushare token。详细配置方法请参考 [环境配置文档](docs/setup.md)。

**快速配置（环境变量方式）**：

```bash
# Windows PowerShell
$env:TUSHARE_TOKEN="your_token_here"

# Linux/Mac
export TUSHARE_TOKEN="your_token_here"
```

更多配置选项（包括邮件通知、企业微信通知等）请参考 [环境配置文档](docs/setup.md)。

### 3. 运行程序

```bash
# 获取TOP10推荐（主板股票）
python stock_selector.py --top-n 10 --board main

# 获取TOP20推荐（默认）
python stock_selector.py --board main

# 强制刷新缓存并获取TOP10
python stock_selector.py --refresh --top-n 10 --board main
```

**注意**：首次运行可能需要较长时间下载数据，建议在网络良好的环境下运行。后续运行会使用缓存数据，速度会快很多。

详细的使用说明和命令行参数请参考 [参数配置文档](docs/configuration.md)。

## 文档导航

本文档采用模块化结构，详细内容请参考以下文档：

### 📚 核心文档

- **[环境配置文档](docs/setup.md)** - 环境配置和安装指南
  - 依赖安装
  - Tushare Token配置
  - 腾讯云邮件推送配置
  - 企业微信通知配置
  - 快速配置检查清单

- **[参数配置文档](docs/configuration.md)** - 参数配置说明
  - 权重配置
  - 命令行参数
  - 板块类型配置
  - 数据获取参数
  - 通知配置

- **[缓存机制文档](docs/cache.md)** - 缓存机制说明
  - SQLite数据库存储
  - 缓存有效期配置
  - 刷新策略
  - 缓存完整性检查
  - 最佳实践建议

- **[评分指标文档](docs/scoring.md)** - 评分指标说明
  - 评分体系概述
  - 各维度详细说明
  - 综合评分计算
  - 缺失指标处理
  - 分数范围与等级

- **[复盘功能文档](docs/review.md)** - 复盘功能说明
  - 功能概述
  - 评分规则
  - 数据库表结构
  - 命令行使用
  - 配置说明
  - 使用示例

- **[Tushare积分文档](docs/tushare.md)** - Tushare积分说明
  - 积分等级对照表
  - API接口要求
  - 评分器数据支持情况
  - 积分等级建议


## 使用说明

### 命令行参数

```bash
python stock_selector.py --help
```

主要参数：

- `--refresh`: 强制刷新缓存
- `--factor-set`: 因子组合 (`fundamental`: 基本面+成交量+价格因子, `index_weight`: 指数权重变化趋势因子)
- `--top-n`: 返回前N只股票（默认10）
- `--stocks`: 指定股票代码列表（如：`--stocks 000001 000002`）
- `--board`: 板块类型（main/sme/gem/star/bse/b），可多选（如：`--board main gem`）
- `--workers`: 线程数（默认10）
- `--notify`: 启用通知功能
- `--notify-throttle`: 启用通知防骚扰模式

详细参数说明请参考 [参数配置文档](docs/configuration.md#命令行参数)。

### 使用示例

```bash
# 选择主板前10只股票
python stock_selector.py --board main --top-n 10

# 评估指定股票
python stock_selector.py --stocks 000001 000002 600000

# 选择主板和创业板股票
python stock_selector.py --board main gem --top-n 30

# 强制刷新缓存
python stock_selector.py --refresh --board main

# 使用指数权重因子组合
python stock_selector.py --factor-set index_weight --top-n 20

# 启用通知功能
python stock_selector.py --board main --top-n 10 --notify
```

更多使用示例请参考 [参数配置文档](docs/configuration.md#使用示例)。

## 程序输出说明

程序运行后会显示以下信息：

### 1. 程序启动信息

```
============================================================
A股选股程序 - 打分策略
============================================================
当前状态：非交易时间，使用最近一个交易日的完整数据进行分析
```

### 2. 数据预加载阶段

程序会先预加载所有股票的数据，显示进度条和统计信息。

### 3. 评分计算阶段

基于预加载的数据计算各维度评分。

### 4. 数据可用性统计

```
============================================================
数据可用性统计:
  基本面数据: XXX/XXX (XX.X%)
  财务数据: XXX/XXX (XX.X%)
============================================================
```

**说明**：如果某个维度的数据可用性为0%，程序会自动调整权重。

### 5. TOP推荐结果

```
============================================================
TOP 10 只股票:
============================================================

【最终打分维度说明】
------------------------------------------------------------
采用的评分维度及权重：
  ✓ 基本面评分: 40.0%
    └─ 子维度: PE市盈率, PB市净率, ROE净资产收益率, 营收增长率, 利润增长率
  ✓ 成交量评分: 30.0%
    └─ 子维度: 量比, 换手率, 成交量趋势
  ✓ 价格评分: 30.0%
    └─ 子维度: 价格趋势, 价格位置, 波动率

【缺失指标提示】
------------------------------------------------------------
  ⚠ 财务数据未采用（数据不可用或权重已调整）
    原因: 财务数据（ROE、增长率）缺失或无效

============================================================
     code    name  total_score  fundamental_score  volume_score  price_score
1  000001  平安银行     85.32             78.50         92.30         88.20
2  000002  万科A       84.15             75.20         90.10         85.30
...

============================================================
【评分说明】
------------------------------------------------------------
总评分 = 基本面评分 × 40.0% + 成交量评分 × 30.0% + 价格评分 × 30.0%
============================================================
```

详细的评分维度说明请参考 [评分指标文档](docs/scoring.md)。

## 常见问题

### Token配置相关问题

#### Q1: 提示"未设置Tushare Token"怎么办？

**解决方法**：
1. 检查是否设置了环境变量
2. 检查config.py中是否设置了TUSHARE_TOKEN
3. 确保Token字符串正确（没有多余的空格或引号）
4. 运行程序测试Token配置是否正确

详细配置方法请参考 [环境配置文档](docs/setup.md#tushare-token配置)。

#### Q2: 提示"权限不足"或"积分不足"怎么办？

**解决方法**：
1. 登录 [Tushare官网](https://tushare.pro/) 查看积分
2. 免费用户（120积分）只能使用基础功能，无法获取财务数据
3. 需要完整功能：建议充值到2000积分以上（200元）

详细说明请参考 [Tushare积分文档](docs/tushare.md)。

### 其他问题

#### Q: 数据获取失败怎么办？

A:
1. 检查网络连接
2. 检查token是否有效（运行程序查看错误信息）
3. 检查积分是否充足
4. 尝试使用 `--refresh` 参数强制刷新
5. 查看错误信息，根据提示解决问题

#### Q: 如何清理缓存？

A: 删除 `cache/` 目录下的文件即可，或使用缓存管理工具。详细说明请参考 [缓存机制文档](docs/cache.md#缓存管理机制)。

#### Q: 程序运行很慢怎么办？

A: 
1. 首次运行会下载数据，需要较长时间
2. 后续运行会使用缓存，速度会快很多
3. 可以调整 `--workers` 参数增加线程数（但要注意tushare的积分限制）
4. 确保网络连接稳定

#### Q: 为什么某些维度的权重显示为0？

A: 如果所有股票都缺失该维度的数据，程序会自动将该维度权重设为0，避免无效数据影响评分。详细说明请参考 [评分指标文档](docs/scoring.md#缺失指标处理)。

#### Q: 如何确保所有维度数据都可用？

A:
1. 确保Tushare Token积分≥2000（免费用户无法获取财务数据）
2. 使用 `--refresh` 参数强制刷新缓存
3. 在网络良好的环境下运行

详细说明请参考 [Tushare积分文档](docs/tushare.md)。

### 通知相关问题

#### Q: 通知功能如何使用？

A:
1. 配置腾讯云邮件推送服务或企业微信机器人
2. 使用 `--notify` 参数启用通知
3. 程序执行完成后会自动发送结果通知

详细配置方法请参考 [环境配置文档](docs/setup.md)。

更多常见问题请参考各详细文档。

## 注意事项

1. **Token配置**：必须配置有效的tushare token才能使用
2. **积分限制**：
   - 免费用户（120积分）只能使用基础功能，无法获取财务数据
   - 建议至少充值到2000积分以使用完整功能
   - 注意每日调用次数限制，合理使用缓存机制
3. **数据延迟**：部分数据可能有延迟，建议在收盘后使用
4. **缓存管理**：首次运行会下载数据，后续运行会使用缓存，速度更快
5. **API调用频率**：注意tushare的调用频率限制，避免触发限流
6. **ST股票**：程序会自动剔除ST股票

## 许可证

本项目仅供学习和研究使用。

## 更新日志

### v1.4.0 (2024-12-19)
- **缓存系统重构**：从Excel存储完全迁移到SQLite数据库
  - 删除所有Excel缓存文件和兼容代码
  - 使用SQLite数据库提供更高效稳定的缓存存储
  - 简化首次运行逻辑，移除数据迁移检测
- **性能优化**：数据库查询比Excel文件操作更快
  - 支持事务操作保证数据一致性
  - 索引优化提升查询性能
  - 并发安全更稳定

### v1.3.0 (2024-12-18)
- **移除板块评分功能**：删除板块走势评分维度
  - 删除 `SectorScorer` 板块评分器
  - 删除板块K线数据获取和缓存逻辑
  - 删除板块趋势统计和显示功能
- **权重重新分配**：调整为三个维度
  - 基本面评分：40%（原35%）
  - 成交量评分：30%（原25%）
  - 价格评分：30%（原25%）
- 简化评分逻辑，提升运行效率

### v1.2.0 (2024-12-17)
- **板块数据优化**：使用 `index_classify` + `index_member` 获取标准行业分类
  - 使用申万一级行业分类（SW2021标准），共31个标准行业
  - 建立股票到行业的映射表，避免名称匹配失败
  - 直接使用行业指数代码获取K线数据，提高数据准确性
  - 首次运行时自动加载行业映射表，后续直接查表，查询速度快
- 修复板块趋势评分全部为50的问题
- 修复房地产等板块股票数量过少的问题

### v1.1.0 (2024-12-17)
- 移除概念维度评分（概念评分器 `concept_scorer.py` 已删除）
- 调整权重配置：基本面35%、成交量25%、价格25%、板块15%
- 更新文档，移除概念评分相关描述

### v1.0.0 (2024-12-15)
- 初始版本
- 基于tushare实现数据获取
- 支持多维度打分策略
- 支持本地缓存机制
- 支持数据预加载
- 完整的Token配置指南和测试工具
- 智能容错机制，自动处理缺失指标
- 根据数据可用性动态调整权重
