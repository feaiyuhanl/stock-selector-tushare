# Change: 默认执行耗时评估与优化方案

## Why

用户希望了解程序默认执行时的耗时分布：哪些步骤是必须的、哪些是可选的，主要阻塞点和卡点在哪里，以及通过哪些方式可以提高执行速度。需要一份基于现有代码的评估文档和可落地的优化方案，便于后续按优先级实施。

## What Changes

- **ADDED**: 在 `docs/` 下新增或更新性能分析文档（如 `docs/performance_analysis.md`），包含：
  - 默认执行流程的耗时阶段划分（启动 → 数据新鲜度检查 → 选股数据加载 → 评分计算 → 复盘 → 飞书同步 → 通知）。
  - 各阶段「必须」与「非必须」的界定：必须为选股核心路径（Token 校验、股票池获取、数据加载与评分、保存推荐）；非必须为数据新鲜度报告、自动复盘、飞书同步、邮件通知、二次重试、Tushare 连接测试等。
  - 主要阻塞点与卡点说明：Tushare API 限频与串行/半串行请求（基本面/财务单股请求、二次重试串行 + sleep）、数据新鲜度报告对全量股票池的 K 线/基本面状态检查、复盘阶段对历史日期的逐股 K 线查询、combined 模式双策略串行执行。
  - 优化方向清单：可配置跳过数据新鲜度报告、提高默认线程数或由配置/CLI 控制、基本面/财务批量或并行优化、二次重试并行化或限流、复盘/飞书异步或可关闭、combined 模式两策略并行执行（若资源允许）等。
- **OPTIONAL（按 tasks 实施）**: 提供可配置项或代码改动，使部分非必须步骤可关闭或加速（如 `--skip-freshness-report`、二次重试并行、复盘/飞书由 config 关闭或异步），不改变默认行为，除非用户显式配置。

## Impact

- **Affected specs**: 新增能力 `execution-performance`（见 `specs/execution-performance/spec.md`）。
- **Affected code**:
  - `docs/performance_analysis.md`（或等价文档）：补充/重写「默认执行耗时评估」与「优化方案」章节。
  - 可选：`stock_selector.py`（数据新鲜度报告可跳过）、`config.py`（新增或暴露性能相关配置）、`strategies/scoring_preloader.py`（二次重试并行/限流）、`core/pipeline.py` 或 `core/executor.py`（combined 并行或复盘/飞书异步）等，具体以 tasks.md 为准。

## 耗时评估摘要（供实现参考）

| 阶段 | 是否必须 | 主要耗时来源 | 卡点/阻塞 |
|------|----------|--------------|-----------|
| Token 校验 | 必须 | 1 次 API/校验 | 低 |
| 数据新鲜度报告 | 非必须 | 全池 K 线状态检查 + 指数权重 + 基本面状态 | 全量 I/O/API，可跳过 |
| 策略创建 + 数据源测试 | 必须/可选 | Tushare 连接测试（已用 test_sources=False 可省） | 低 |
| 股票池获取 | 必须 | 本地/API | 低 |
| 阶段1 数据准备 | 必须 | 批量 K 线缓存检查（≥50 只时批量） | 中等，依赖缓存与 API |
| 阶段2 数据加载 | 必须 | 每只股票：K 线（或批量）+ 基本面 + 财务，多线程但基本面/财务为单股 API | **主要卡点**：API 限频与串行请求 |
| 二次重试 | 非必须 | 缺失基本面/财务的股票逐个重试 + sleep(0.1) | **卡点**：串行 + 延迟 |
| 阶段3 评分计算 | 必须 | CPU，内存内计算 | 相对较低 |
| 保存推荐 | 必须 | DB 写入 | 低 |
| 自动复盘 | 非必须 | 按日期 × 策略 × 股票，查 K 线、算表现、写 DB | **卡点**：大量 K 线查询 |
| 飞书同步 | 非必须 | 读 DB + 飞书 API | 中等 |
| 邮件通知 | 非必须 | 仅当 `--notify` | 低 |

优化优先级建议：1）数据新鲜度报告可配置跳过；2）二次重试并行化或取消/缩短 sleep；3）适当提高默认线程数（注意 Tushare 限频）；4）复盘/飞书由 config 关闭或延后；5）combined 模式两策略并行（可选）。
