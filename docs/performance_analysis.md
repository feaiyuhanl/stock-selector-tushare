# 数据加载与默认执行性能分析

## 默认执行流程耗时阶段

默认执行（如 `python stock_selector.py --factor-set combined`）的流程与主要耗时来源如下：

| 阶段 | 主要耗时来源 |
|------|--------------|
| 启动 | 模块导入、Token 校验（1 次）、策略创建（含可选数据源测试） |
| 数据新鲜度检查 | 全股票池 K 线缓存状态检查、指数权重逐指数查询、基本面批量状态检查（与选股内检查重复） |
| 选股数据加载 | 阶段1：批量 K 线缓存检查/加载（≥50 只时批量）；阶段2：每只股票 K 线 + 基本面 + 财务（多线程，但基本面/财务为单股 API） |
| 二次重试 | 对缺失基本面/财务的股票再次请求（原为串行 + sleep） |
| 评分计算 | 内存内计算，相对较低 |
| 保存推荐 | DB 写入，低 |
| 自动复盘 | 按日期×策略×股票查 K 线、算表现、写 DB，大量 K 线请求 |
| 飞书同步 | 读 DB + 飞书 API |
| 通知 | 仅当 `--notify` 时发送邮件 |

## 必须 vs 非必须

- **必须步骤**（无则无法得到选股结果）：Token 校验、股票池获取、选股数据加载（K 线/基本面/财务）、评分计算、保存推荐。
- **非必须步骤**（关闭或延后不影响「得到 TOP 推荐并落库」）：
  - **数据新鲜度报告**：选股前输出缓存概况，仅提示用；可通过 `--skip-freshness-report` 或 `config.SKIP_FRESHNESS_REPORT=True` 跳过以缩短首屏时间。
  - **二次重试**：补全缺失基本面/财务，提升评分覆盖，非必须才能出结果。
  - **自动复盘**：由 `config.AUTO_REVIEW_CONFIG.enabled` 控制，关闭可显著缩短时间。
  - **飞书同步**：由 `config.FEISHU_SHEETS_CONFIG.enabled` 控制。
  - **邮件通知**：仅当传入 `--notify` 时执行。

## 主要阻塞点与卡点

1. **阶段2 数据加载**：每只股票在线程内串行调用 `get_stock_fundamental`、`get_stock_financial`，无批量 API；总耗时受「股票数 × (基本面+财务) 单次时间 / 线程数」及 Tushare 限频约束。**卡点**：API 限频与单股串行。
2. **二次重试**：对缺失基本面/财务的股票再次请求。原实现为逐个请求 + `time.sleep(0.1)`，重试量大时线性增加耗时。**已优化**：改为线程池并行重试（默认 2 线程）、缩短间隔，控制限频风险。
3. **数据新鲜度报告**：选股前对全股票池做 K 线/指数/基本面状态检查，与选股内部检查重复。**卡点**：全量 I/O/API，可跳过以缩短首屏时间（见「优化方案」）。
4. **自动复盘**：按日期×策略×股票循环，每条可能多次查 K 线。**卡点**：复盘阶段 K 线请求集中。
5. **combined 模式**：两策略串行执行，总耗时约为两策略耗时之和；可选方向为两策略并行（实现成本较高）。

## 优化方案与优先级

| 优先级 | 方案 | 说明 | 风险/注意 |
|--------|------|------|-----------|
| P1 | 跳过数据新鲜度报告 | 使用 `--skip-freshness-report` 或 `config.SKIP_FRESHNESS_REPORT=True`，选股前不执行 `print_data_freshness_report` | 用户看不到选股前缓存概况；需查看时可不加该选项 |
| P2 | 二次重试并行 | 已实现：线程池并行重试（默认 2 线程）、缩短单次间隔，控制 Tushare 限频 | 并发不宜过高，当前 2 线程为折中 |
| P3 | 默认线程数 | 当前 `config.DEFAULT_MAX_WORKERS=3`；在限频与内存允许下可调高（推荐 3–8），过高易触发限频或 OOM；可通过 `--workers N` 覆盖 | 见下节「默认线程数」 |
| P4 | 复盘/飞书可关闭 | 由 `AUTO_REVIEW_CONFIG.enabled`、`FEISHU_SHEETS_CONFIG.enabled` 控制，关闭后可显著缩短时间 | 无 |
| P5 | combined 两策略并行 | 两策略并行跑再合并结果；需处理共享 DB/缓存，为可选后续项 | 实现与测试成本较高 |

## 默认线程数与批量阈值

- **当前**：`config.DEFAULT_MAX_WORKERS = 3`，主流程（`scoring_strategy`、`scoring_preloader`）在 `max_workers=None` 时使用该值；命令行 `--workers N` 会正确传递并覆盖。
- **推荐范围**：3–8。过高易触发 Tushare 限频或内存压力；内存受限环境建议 2–5。
- **K 线批量**：仅当股票数 ≥50 时走批量检查/加载；少于 50 只时逐只处理，小股票池耗时会相对明显。

---

## 性能瓶颈分析（原有内容）

### 1. 线程数配置（已统一）

**当前**：`config.py` 中 `DEFAULT_MAX_WORKERS = 3`（内存与限频折中）；`scoring_strategy`、`scoring_preloader` 在 `max_workers=None` 时使用该值，命令行 `--workers N` 会正确传递并覆盖，无硬编码覆盖主流程。

**建议**：在限频与内存允许下可将 `DEFAULT_MAX_WORKERS` 调高至 3–8；过高易触发 Tushare 限频或 OOM。

### 2. 基本面和财务数据串行获取

**问题**：
- K线数据有批量获取优化（按日期批量查询）
- 但基本面和财务数据仍然是逐个股票串行获取
- 每个股票的基本面和财务数据在同一个线程内串行请求

**影响**：
- 对于2000+只股票，即使有5个线程，每个线程需要串行处理约400只股票
- 每只股票的基本面数据需要1次API调用
- 每只股票的财务数据需要2次API调用（fina_indicator + income）
- 总API调用次数：2000 × (1 + 2) = 6000次

**解决方案**：
- 考虑实现基本面和财务数据的批量获取接口
- 或者增加线程数，充分利用并行处理能力
- 优化缓存策略，减少不必要的API调用

### 3. 二次重试机制（已优化）

**原问题**：预加载完成后对缺失基本面/财务的股票逐个重试，且 `time.sleep(0.1)`，重试量大时线性增加耗时。

**已实现**：二次重试改为线程池并行（默认 2 线程），缩短单次间隔，控制 Tushare 限频风险。详见 `strategies/scoring_preloader.py` 中「二次重试」段落。

### 4. 财务数据获取复杂

**问题**：
- 财务数据需要两次API调用：`fina_indicator` 和 `income`
- 获取的是2年历史数据（`timedelta(days=730)`），数据量较大
- 计算增长率需要处理多个季度/年度的数据

**影响**：
- 每次财务数据获取的时间较长（可能需要1-2秒）
- 对于大量股票，累积时间会很长

**解决方案**：
- 优化数据获取逻辑，减少不必要的历史数据
- 考虑使用缓存更长时间（财务数据变化频率低）
- 优化计算逻辑，减少数据处理时间

### 5. K线数据批量加载优化不足

**问题**：
- K线数据虽然实现了批量获取优化，但只针对超过50只股票的情况
- 对于少于50只股票的情况，仍然使用逐个获取方式

**影响**：
- 小规模股票列表也无法享受批量优化
- 可能导致不必要的API调用

**解决方案**：
- 降低批量加载的阈值，或者总是使用批量加载

## 性能优化建议

### 优先级1：线程数（已统一）

主流程已使用 `config.DEFAULT_MAX_WORKERS`，`--workers N` 正确传递。可根据限频与内存将 `DEFAULT_MAX_WORKERS` 调至 3–8。

### 优先级2：优化缓存策略

**建议**：
- 充分利用缓存，减少API调用
- 首次运行后，后续运行应该主要从缓存读取
- 检查缓存有效期设置是否合理

### 优先级3：优化数据获取逻辑

**建议**：
- 对于基本面和财务数据，考虑实现批量获取
- 优化财务数据获取，减少不必要的历史数据
- 二次重试已改为并行执行，见上文「二次重试机制（已优化）」

### 优先级4：监控和诊断

**建议**：
- 添加性能监控，记录各阶段的耗时
- 输出详细的性能统计信息
- 帮助用户识别性能瓶颈

## 性能测试建议

1. **首次运行**：测试完全没有缓存的情况下的性能
2. **后续运行**：测试有缓存的情况下的性能
3. **部分刷新**：测试部分数据需要更新的情况下的性能

## 预期性能提升与可选配置

- **跳过数据新鲜度报告**：使用 `--skip-freshness-report` 或 `config.SKIP_FRESHNESS_REPORT=True`，可缩短选股前全量检查耗时（详见上文「优化方案与优先级」P1）。
- **线程数**：在限频与内存允许下，将 `DEFAULT_MAX_WORKERS` 或 `--workers` 调高（推荐 3–8），可缩短阶段2 数据加载时间；过高易触发限频或 OOM。
- **关闭复盘/飞书**：`AUTO_REVIEW_CONFIG.enabled=False`、`FEISHU_SHEETS_CONFIG.enabled=False` 可显著缩短选股后耗时。

