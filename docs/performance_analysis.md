# 数据加载性能分析

## 性能瓶颈分析

### 1. 线程数配置问题 ⚠️ 关键问题

**问题**：虽然配置文件 `config.py` 中 `DEFAULT_MAX_WORKERS = 10`，但代码中多处硬编码为 `max_workers: int = 5`

**位置**：
- `strategies/scoring_strategy.py:61` - `preload_all_data` 方法默认参数 `max_workers: int = 5`
- `strategies/scoring_strategy.py:86` - `select_top_stocks` 方法默认参数 `max_workers: int = 5`
- `strategies/scoring_preloader.py:28` - `preload_all_data` 方法默认参数 `max_workers: int = 5`

**影响**：
- 即使用户通过 `--workers 20` 命令行参数设置线程数，实际仍会被限制为5
- 对于大量股票（如主板约2184只），线程数只有5会导致数据加载非常慢

**解决方案**：
- 移除硬编码的默认值，改为使用 `config.DEFAULT_MAX_WORKERS`
- 确保命令行参数 `--workers` 的值能正确传递到数据加载方法

### 2. 基本面和财务数据串行获取

**问题**：
- K线数据有批量获取优化（按日期批量查询）
- 但基本面和财务数据仍然是逐个股票串行获取
- 每个股票的基本面和财务数据在同一个线程内串行请求

**影响**：
- 对于2000+只股票，即使有5个线程，每个线程需要串行处理约400只股票
- 每只股票的基本面数据需要1次API调用
- 每只股票的财务数据需要2次API调用（fina_indicator + income）
- 总API调用次数：2000 × (1 + 2) = 6000次

**解决方案**：
- 考虑实现基本面和财务数据的批量获取接口
- 或者增加线程数，充分利用并行处理能力
- 优化缓存策略，减少不必要的API调用

### 3. 二次重试机制增加延迟

**问题**：
- 在 `strategies/scoring_preloader.py:304-365` 中，预加载完成后会进行二次重试
- 对于所有缺失基本面和财务数据的股票，会再次逐个请求
- 每个请求之间有 `time.sleep(0.1)` 延迟

**影响**：
- 如果很多股票缺少数据，二次重试会增加大量时间
- 0.1秒的延迟乘以重试股票数量，会显著增加总耗时

**解决方案**：
- 优化缓存策略，减少首次加载时的数据缺失
- 考虑在首次加载时就进行重试，而不是单独进行二次重试
- 或者将二次重试改为并行执行

### 4. 财务数据获取复杂

**问题**：
- 财务数据需要两次API调用：`fina_indicator` 和 `income`
- 获取的是2年历史数据（`timedelta(days=730)`），数据量较大
- 计算增长率需要处理多个季度/年度的数据

**影响**：
- 每次财务数据获取的时间较长（可能需要1-2秒）
- 对于大量股票，累积时间会很长

**解决方案**：
- 优化数据获取逻辑，减少不必要的历史数据
- 考虑使用缓存更长时间（财务数据变化频率低）
- 优化计算逻辑，减少数据处理时间

### 5. K线数据批量加载优化不足

**问题**：
- K线数据虽然实现了批量获取优化，但只针对超过50只股票的情况
- 对于少于50只股票的情况，仍然使用逐个获取方式

**影响**：
- 小规模股票列表也无法享受批量优化
- 可能导致不必要的API调用

**解决方案**：
- 降低批量加载的阈值，或者总是使用批量加载

## 性能优化建议

### 优先级1：修复线程数配置问题（立即修复）

**修改位置**：
1. `strategies/scoring_strategy.py` - 移除硬编码的 `max_workers: int = 5`，使用 `config.DEFAULT_MAX_WORKERS`
2. `strategies/scoring_preloader.py` - 同样修改

**预期效果**：
- 使用默认10线程，性能提升约2倍
- 如果用户设置 `--workers 20`，性能可再提升约2倍

### 优先级2：优化缓存策略

**建议**：
- 充分利用缓存，减少API调用
- 首次运行后，后续运行应该主要从缓存读取
- 检查缓存有效期设置是否合理

### 优先级3：优化数据获取逻辑

**建议**：
- 对于基本面和财务数据，考虑实现批量获取
- 优化财务数据获取，减少不必要的历史数据
- 改进二次重试机制，减少延迟

### 优先级4：监控和诊断

**建议**：
- 添加性能监控，记录各阶段的耗时
- 输出详细的性能统计信息
- 帮助用户识别性能瓶颈

## 性能测试建议

1. **首次运行**：测试完全没有缓存的情况下的性能
2. **后续运行**：测试有缓存的情况下的性能
3. **部分刷新**：测试部分数据需要更新的情况下的性能

## 预期性能提升

通过修复线程数配置问题：
- 从5线程提升到10线程：性能提升约 **2倍**
- 从5线程提升到20线程：性能提升约 **4倍**

配合其他优化：
- 总体性能提升可达 **3-5倍**

