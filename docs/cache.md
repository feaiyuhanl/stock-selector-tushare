# 缓存机制说明

本文档详细说明程序的缓存机制，包括缓存策略、数据库结构、刷新机制等。

## 目录

- [缓存概述](#缓存概述)
- [SQLite数据库存储](#sqlite数据库存储)
- [缓存有效期配置](#缓存有效期配置)
- [刷新策略](#刷新策略)
- [缓存完整性检查](#缓存完整性检查)
- [缓存管理机制](#缓存管理机制)
- [最佳实践建议](#最佳实践建议)

---

## 缓存概述

程序使用SQLite数据库进行数据缓存，提供高效稳定的本地存储。所有数据（K线、基本面、财务、指数权重）都自动缓存到本地SQLite数据库，大幅提升运行速度。

### 缓存优势

- **高效稳定**：SQLite数据库提供高效的查询和存储
- **并发安全**：数据库级别的锁机制，保证多线程操作的安全性
- **增量更新**：支持增量更新，避免重复下载数据
- **自动清理**：自动清理过期数据，控制存储空间

---

## SQLite数据库存储

### 数据库文件位置

```
cache/
└── stock_cache.db          # SQLite数据库文件
```

数据库文件会在首次运行时自动创建。

### 数据库表结构

程序使用以下数据表存储不同类型的缓存数据：

| 表名 | 用途 | 主要字段 |
|------|------|----------|
| `fundamental_data` | 基本面数据（PE、PB、ROE等） | ts_code, trade_date, pe, pb, ... |
| `financial_data` | 财务数据（ROE等） | ts_code, end_date, roe, ... |
| `stock_sectors` | 板块数据 | ts_code, sector, ... |
| `stock_concepts` | 概念数据 | ts_code, concept, ... |
| `stock_list` | 股票列表 | ts_code, symbol, name, ... |
| `kline_data` | K线数据 | ts_code, trade_date, open, close, ... |
| `index_weight_data` | 指数权重数据 | index_code, trade_date, con_code, weight |

### 数据库特性

- **索引优化**：关键字段建立索引，提升查询性能
- **事务支持**：支持事务操作，保证数据一致性
- **并发安全**：数据库级别的锁机制，支持多线程并发访问

---

## 缓存有效期配置

不同数据类型有不同的缓存有效期（超过有效期后，缓存自动失效，会重新从API获取数据）：

| 数据类型 | 缓存有效期 | 说明 |
|---------|-----------|------|
| **K线数据** | 1天（当日有效） | 必须是今天，否则失效；检查最新交易日数据；自动保留最近250个交易日（约1年） |
| **股票列表** | 1天 | 超过1天自动失效，重新获取 |
| **基本面数据** | 7天 | 超过7天自动失效，重新获取 |
| **财务数据** | 7天 | 超过7天自动失效，重新获取（变化频率低） |
| **指数权重数据** | 1天 | 当日数据实时更新，缓存有效期1天；历史数据永久保存（用于趋势分析） |

**注意**：
- 缓存有效期是指缓存数据的有效期，超过有效期后会自动失效并重新获取数据
- K线数据会自动清理，只保留最近250个交易日（约1年）的数据
- 可在 `config.py` 中通过 `KLINE_CACHE_RETENTION_DAYS` 配置项调整K线数据保留天数

---

## 刷新策略

### K线数据刷新策略

#### 智能日期检查

- **优先检查**：优先检查缓存文件是否包含最新交易日的数据
- **交易时间感知**：
  - 交易时间内（9:30-11:30, 13:00-15:00）：使用昨天的完整数据（今天数据不完整）
  - 收盘后（15:00之后）：可以使用今天的数据（完整收盘数据）
  - 开盘前（9:30之前）：使用昨天的数据
  - 周末/非交易时间：使用最近一个交易日的完整数据
- **自动刷新**：如果缓存中最新数据不是最新交易日，自动从API获取最新数据
- **增量更新**：只获取缓存中最新日期之后的新数据，不会重复获取已存在的数据
- **自动清理**：保存时自动清理超过保留天数的旧数据，默认保留最近250个交易日（约1年）

#### 数据更新流程

1. 检查缓存中最新数据的日期
2. 判断当前是否为交易时间
3. 确定应该使用哪个交易日的数据
4. 如果缓存数据不是最新交易日，自动从API获取新数据
5. 合并新数据到缓存（增量更新）
6. 清理超过保留天数的旧数据

### 其他数据刷新策略

#### 基本面数据

- **缓存有效期**：7天
- **刷新机制**：超过7天自动失效并重新获取
- **验证机制**：读取时验证数据有效性

#### 财务数据

- **缓存有效期**：7天
- **刷新机制**：超过7天自动失效并重新获取（变化频率低）
- **强制刷新**：可通过 `--refresh` 参数强制刷新

#### 指数权重数据

- **当日数据**：实时更新，缓存有效期1天
- **历史数据**：永久保存（用于趋势分析）
- **数据清理**：保留最近250个交易日的数据（约1年）
- **增量更新**：支持按日期增量更新，避免重复下载已有数据

---

## 缓存完整性检查

程序启动时会自动检查缓存完整性：

### 覆盖率检查

- **抽样检查**：抽样检查缓存覆盖率（最多检查1000只股票）
- **自动预加载**：如果覆盖率低于50%，自动触发数据预加载
- **断点续传**：支持独立文件存储，便于断点续传

### 数据验证

- **数据格式验证**：检查数据格式是否正确
- **数据完整性验证**：检查必要字段是否完整
- **数据有效性验证**：检查数据是否在有效期内

---

## 缓存管理机制

### 强制刷新机制

使用 `--refresh` 参数可以强制刷新所有缓存：

```bash
# 强制刷新所有缓存
python stock_selector.py --refresh --board main
```

**强制刷新的行为**：
- 忽略所有缓存有效期检查
- 所有数据都从API重新获取
- 更新后的数据会保存到缓存

### 缓存清理机制

#### 自动清理

- **K线数据**：保存时自动清理超过保留天数的旧数据（默认250个交易日）
- **其他数据**：根据缓存有效期自动失效

#### 手动清理

如需完全清理缓存：

1. **删除数据库文件**：直接删除 `cache/stock_cache.db` 文件
2. **删除缓存目录**：删除整个 `cache/` 目录
3. **程序会自动重新创建**：程序会在下次运行时自动重新创建缓存目录和数据库文件

### 缓存更新时机

| 场景 | 刷新行为 |
|------|---------|
| **首次运行** | 所有数据从API获取并缓存（K线数据获取最近120天） |
| **日常运行** | 根据缓存有效期自动检查，过期数据自动失效并重新获取；K线数据增量更新（只获取新数据） |
| **使用 `--refresh`** | 强制刷新所有数据（K线数据重新获取最近120天，但会保留超过120天的旧数据） |
| **缓存无效** | 自动删除无效缓存并重新获取 |
| **覆盖率不足** | 自动触发预加载 |

### K线数据管理机制

- **增量更新**：日常运行时，只获取缓存中最新日期之后的新数据，不会重复获取已存在的数据
- **数据合并**：新数据会与现有缓存数据合并，保留所有历史数据
- **自动清理**：保存时自动清理超过保留天数的旧数据，默认保留最近250个交易日（约1年）
- **配置项**：可在 `config.py` 中通过 `KLINE_CACHE_RETENTION_DAYS` 调整保留天数

---

## 最佳实践建议

### 首次使用

1. **首次运行会下载所有数据**，需要较长时间，建议在网络良好的环境下运行
2. **确保有足够的存储空间**（缓存数据库可能达到几百MB）
3. **确保网络连接稳定**，避免数据获取中断

### 日常使用

1. **正常运行时使用缓存**，速度会快很多；K线数据会自动检查最新交易日
2. **财务数据变化频率低**，缓存有效期7天；如需立即获取最新数据，使用 `--refresh` 参数强制刷新
3. **定期检查缓存大小**，如果缓存文件过大，可以考虑清理

### 缓存清理

1. **K线数据会自动清理**，只保留最近250个交易日（约1年）的数据
2. **如需完全清理缓存**，直接删除 `cache/` 目录；程序会自动重新创建缓存目录
3. **可在 `config.py` 中通过 `KLINE_CACHE_RETENTION_DAYS` 调整K线数据保留天数**

### 性能优化

1. **合理使用缓存**：避免频繁使用 `--refresh` 参数，充分利用缓存机制
2. **监控缓存大小**：定期检查缓存文件大小，避免占用过多存储空间
3. **网络优化**：在网络良好的环境下运行，提升数据获取速度
4. **并发控制**：合理设置线程数（`--workers` 参数），避免触发API限流

### 故障排查

1. **缓存数据异常**：使用 `--refresh` 参数强制刷新数据
2. **缓存文件损坏**：删除缓存文件，让程序重新创建
3. **数据不完整**：检查网络连接和API调用是否正常
4. **查看缓存详情**：使用 `--cache-info` 参数查看指定股票的缓存数据详情

---

## 相关文档

- [参数配置文档](configuration.md) - 缓存相关的配置参数
- [环境配置文档](setup.md) - 环境配置说明

